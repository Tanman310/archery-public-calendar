<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>East Middle Missiles Archery Calendar</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      color-scheme: light;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    header .sub {
      margin-top: 4px;
      font-size: 13px;
      opacity: 0.7;
    }

    .wrap {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto 32px;
    }

    .intro {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      border: 1px solid #e9e9e9;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.03);
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #4b4b4b;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: #333;
    }

    .legend {
      display: grid;
      gap: 8px;
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      font-size: 12px;
      color: #555;
    }

    .legend li {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 6px;
      font-size: 10px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #f6f6f6;
    }

    .status {
      font-size: 13px;
      padding: 10px 12px;
      border: 1px solid #e9e9e9;
      border-radius: 10px;
      margin-top: 8px;
      background: #fafafa;
    }

    .status.error {
      border-color: #f3b3b3;
      background: #fff5f5;
    }

    .status.ok {
      border-color: #cfe9d1;
      background: #f6fff7;
    }

    .status-meta {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }

    #calendar {
      background: #fff;
      border: 1px solid #e9e9e9;
      border-radius: 14px;
      padding: 8px;
    }

    /* Past events: dim */
    .fc-event.is-past {
      opacity: 0.55;
    }

    /* Canceled events: strike + tag + dim a bit more */
    .fc-event.is-canceled .fc-event-title,
    .fc-event.is-canceled .fc-event-title-container,
    .fc-event.is-canceled .fc-event-main {
      text-decoration: line-through;
    }

    .fc-event.is-canceled {
      opacity: 0.45;
      filter: grayscale(0.25);
    }

    .canceled-badge {
      display: inline-block;
      font-size: 10px;
      line-height: 1;
      padding: 2px 6px;
      border-radius: 999px;
      margin-left: 6px;
      border: 1px solid rgba(0, 0, 0, 0.25);
      background: rgba(255, 255, 255, 0.7);
    }

    /* Make list view more readable on phones */
    @media (max-width: 640px) {
      #calendar {
        padding: 6px;
      }

      .fc .fc-toolbar {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }

      .fc .fc-toolbar-chunk {
        display: flex;
        justify-content: space-between;
      }

      .fc .fc-toolbar-title {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>East Middle Missiles Archery Calendar</h1>
    <div class="sub">Events published from the team schedule.</div>
  </header>

  <main class="wrap">
    <section class="intro" aria-label="Introduction and status">
      <div class="card">
        <h2>How to use</h2>
        <p>Tap an event to see details. Colors group events by category, and canceled events are clearly labeled.</p>
        <ul class="legend">
          <li><span role="img" aria-label="All-day event">üóìÔ∏è</span> All-day events show without a time.</li>
          <li><span role="img" aria-label="Past event">‚è≥</span> Past events appear dimmed.</li>
          <li><span role="img" aria-label="Canceled event">üö´</span> Canceled events are crossed out.</li>
        </ul>
      </div>
      <div class="card">
        <h2>Status</h2>
        <p id="status" class="status">Loading events‚Ä¶</p>
        <div id="updated" class="status-meta">Last updated: ‚Äî</div>
      </div>
    </section>
    <section id="calendar" class="card" aria-label="Event calendar"></section>
  </main>

  <script type="module">
    import { toFullCalendarEvent } from "./src/calendar.js";
    /**
     * STEP 1: Paste your published CSV URL for the `public_events` sheet here.
     * Example format:
     * https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv
     */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT3BCyENImsHmP4TtOg2PMZkauaCWHc8wu4xSSmeU-jUgKVn6U1jpVQCHK0ACZoUtzjenfqyhdNu4PF/pub?gid=1881779158&single=true&output=csv";

    // Expected CSV headers (row 1):
    // Event Date, Start Time, End Time, Title, Location, Category, Canceled
    // Also accepts: Date, Start, End (for compatibility with existing sheets)

    function setStatus(text, kind = "") {
      const el = document.getElementById("status");
      el.textContent = text;
      el.classList.remove("error", "ok");
      if (kind) el.classList.add(kind);
    }

    function setUpdated(timestamp) {
      const el = document.getElementById("updated");
      if (!el) return;
      const formatted = timestamp
        ? new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short"
        }).format(timestamp)
        : "‚Äî";
      el.textContent = `Last updated: ${formatted}`;
    }

    function stableColorForCategory(category) {
      // deterministic HSL color from string
      const s = String(category ?? "Other");
      let hash = 0;
      for (let i = 0; i < s.length; i++) hash = (hash * 31 + s.charCodeAt(i)) >>> 0;
      const hue = hash % 360;
      // Keep colors readable
      return {
        backgroundColor: `hsl(${hue} 70% 45%)`,
        borderColor: `hsl(${hue} 70% 35%)`
      };

    }
    async function loadCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results),
          error: (err) => reject(err)
        });
      });
    }

    async function main() {
      if (!CSV_URL || CSV_URL === "YOUR_CSV_URL_HERE") {
        setStatus("Error: Paste your published CSV URL into CSV_URL in index.html.", "error");
        return;
      }

      setStatus("Loading events‚Ä¶");
      setUpdated(null);
      let parsed;
      try {
        parsed = await loadCSV(CSV_URL);
      } catch (e) {
        setStatus("Error loading CSV. Verify the sheet is published to the web as CSV and the URL is correct.", "error");
        return;
      }

      if (parsed.errors && parsed.errors.length) {
        setStatus("CSV parsed with errors. Check the published tab and header row formatting.", "error");
        // continue anyway
      }

      const rows = Array.isArray(parsed.data) ? parsed.data : [];
      const events = [];
      for (const row of rows) {
        const ev = toFullCalendarEvent(row);
        if (ev) events.push(ev);
      }

      if (!events.length) {
        setStatus("No events found. Confirm your public_events tab has rows and the expected headers.", "error");
        return;
      }

      setStatus(`Loaded ${events.length} events.`, "ok");
      setUpdated(new Date());

      const isMobile = window.matchMedia("(max-width: 640px)").matches;
      const initialView = isMobile ? "listMonth" : "dayGridMonth";

      const calendarEl = document.getElementById("calendar");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView,
        height: "auto",
        nowIndicator: true,
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,listMonth"
        },
        events,

        // Display times in 12-hour format
        eventTimeFormat: {
          hour: "numeric",
          minute: "2-digit",
          meridiem: "short"
        },

        // Include location + category + canceled status in popover
        eventDidMount: function (info) {
          const { location, category, canceled } = info.event.extendedProps;

          // Add canceled badge for quick scan
          if (canceled) {
            const titleEl = info.el.querySelector(".fc-event-title");
            if (titleEl && !info.el.querySelector(".canceled-badge")) {
              const badge = document.createElement("span");
              badge.className = "canceled-badge";
              badge.textContent = "Canceled";
              titleEl.appendChild(badge);
            }
          }

          // Tooltip (native title)
          const parts = [];
          if (category) parts.push(category);
          if (location) parts.push(location);
          if (canceled) parts.push("Canceled");
          if (parts.length) info.el.title = parts.join(" ‚Ä¢ ");
        }
      });

      calendar.render();

      // Optional: re-render on resize to switch default view if desired
      // (Leave disabled to avoid jarring view switches)
    }

    main();
  </script>
</body>

</html>