<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>East Middle Missiles Archery Calendar</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      color-scheme: light;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    header .sub {
      margin-top: 4px;
      font-size: 13px;
      opacity: 0.7;
    }

    .wrap {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto 32px;
    }

    .intro {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      border: 1px solid #e9e9e9;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.03);
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #4b4b4b;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: #333;
    }

    .legend {
      display: grid;
      gap: 8px;
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      font-size: 12px;
      color: #555;
    }

    .legend li {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 6px;
      font-size: 10px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #f6f6f6;
    }

    .status {
      font-size: 13px;
      padding: 10px 12px;
      border: 1px solid #e9e9e9;
      border-radius: 10px;
      margin-top: 8px;
      background: #fafafa;
    }

    .status.error {
      border-color: #f3b3b3;
      background: #fff5f5;
    }

    .status.ok {
      border-color: #cfe9d1;
      background: #f6fff7;
    }

    .status-meta {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }

    #calendar {
      background: #fff;
      border: 1px solid #e9e9e9;
      border-radius: 14px;
      padding: 8px;
    }

    /* Past events: dim */
    .fc-event.is-past {
      opacity: 0.55;
    }

    /* Canceled events: strike + tag + dim a bit more */
    .fc-event.is-canceled .fc-event-title,
    .fc-event.is-canceled .fc-event-title-container,
    .fc-event.is-canceled .fc-event-main {
      text-decoration: line-through;
    }

    .fc-event.is-canceled {
      opacity: 0.45;
      filter: grayscale(0.25);
    }

    .canceled-badge {
      display: inline-block;
      font-size: 10px;
      line-height: 1;
      padding: 2px 6px;
      border-radius: 999px;
      margin-left: 6px;
      border: 1px solid rgba(0, 0, 0, 0.25);
      background: rgba(255, 255, 255, 0.7);
    }

    /* Make list view more readable on phones */
    @media (max-width: 640px) {
      #calendar {
        padding: 6px;
      }

      .fc .fc-toolbar {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }

      .fc .fc-toolbar-chunk {
        display: flex;
        justify-content: space-between;
      }

      .fc .fc-toolbar-title {
        font-size: 16px;
      }
    }

    /* Past-date muting */
    .fc .is-past {
      background: #f3f4f6;
    }
    .fc .is-past .fc-daygrid-day-number {
      color: #6b7280;
    }
    .fc .is-past .fc-daygrid-day-frame {
      opacity: 0.65;
    }
    .fc .event-past {
      opacity: 0.6;
    }

    /* Modal */
    body.modal-open {
      overflow: hidden;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 9999;
    }
    .modal.open {
      display: block;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
    }
    .modal-panel {
      position: relative;
      max-width: 560px;
      margin: 8vh auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.22);
      padding: 18px 18px 16px;
      width: calc(100% - 24px);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 12px;
      border: none;
      background: transparent;
      font-size: 28px;
      line-height: 1;
      cursor: pointer;
      color: #374151;
    }
    .modal-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-right: 24px;
    }
    .modal-title {
      margin: 0;
      font-size: 20px;
      line-height: 1.25;
    }
    .modal-meta {
      margin-top: 12px;
      display: grid;
      gap: 8px;
      color: #111827;
    }

    @media (max-width: 640px) {
      .modal-panel {
        margin: 10vh auto;
        padding: 16px 14px 14px;
      }
      .modal-title {
        font-size: 18px;
      }
    }

  </style>
</head>

<body>
  <header>
    <h1>East Middle Missiles Archery Calendar</h1>
    <div class="sub">Events published from the team schedule.</div>
  </header>

  <main class="wrap">
    <section class="intro" aria-label="Introduction and status">
      <div class="card">
        <h2>How to use</h2>
        <p>Tap an event to see details. Colors group events by category, and canceled events are clearly labeled.</p>
        <ul class="legend">
          <li><span role="img" aria-label="All-day event">üóìÔ∏è</span> All-day events show without a time.</li>
          <li><span role="img" aria-label="Past event">‚è≥</span> Past events appear dimmed.</li>
          <li><span role="img" aria-label="Canceled event">üö´</span> Canceled events are crossed out.</li>
        </ul>
      </div>
      <div class="card">
        <h2>Status</h2>
        <p id="status" class="status">Loading events‚Ä¶</p>
        <div id="updated" class="status-meta">Last updated: ‚Äî</div>
      </div>
    </section>
    <section id="calendar" class="card" aria-label="Event calendar"></section>
  </main>


  <!-- Event Details Modal -->
  <div id="eventModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-panel" role="document" aria-label="Event details">
      <button class="modal-close" type="button" aria-label="Close" data-close>&times;</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script type="module">
    import { toFullCalendarEvent } from "./src/calendar.js";
    /**
     * STEP 1: Paste your published CSV URL for the `public_events` sheet here.
     * Example format:
     * https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv
     */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT3BCyENImsHmP4TtOg2PMZkauaCWHc8wu4xSSmeU-jUgKVn6U1jpVQCHK0ACZoUtzjenfqyhdNu4PF/pub?gid=1881779158&single=true&output=csv";


    function startOfWeekSunday(dateLike) {
      const d = new Date(dateLike);
      d.setHours(0, 0, 0, 0);
      const day = d.getDay(); // 0 = Sunday
      d.setDate(d.getDate() - day);
      return d;
    }

    function addDays(dateLike, days) {
      const d = new Date(dateLike);
      d.setDate(d.getDate() + days);
      return d;
    }

    function formatDateLong(dateLike) {
      if (!dateLike) return "";
      return new Intl.DateTimeFormat(undefined, { weekday: "long", month: "long", day: "numeric", year: "numeric" }).format(dateLike);
    }

    function formatTimeRange(start, end, allDay) {
      if (allDay) return "All day";
      const timeFmt = new Intl.DateTimeFormat(undefined, { hour: "numeric", minute: "2-digit" });
      if (!start && !end) return "";
      if (start && end) return `${timeFmt.format(start)} ‚Äì ${timeFmt.format(end)}`;
      return start ? timeFmt.format(start) : timeFmt.format(end);
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function openEventModal(event) {
      const modal = document.getElementById("eventModal");
      const content = document.getElementById("modalContent");

      const title = event.title || "Event";
      const start = event.start;
      const end = event.end;
      const props = event.extendedProps || {};
      const location = props.location || "";
      const category = props.category || "";
      const canceled = !!props.canceled;
      const allDay = !!event.allDay;

      const timeText = formatTimeRange(start, end, allDay);
      const dateText = formatDateLong(start);

      content.innerHTML = `
        <div class="modal-title-row">
          <h3 class="modal-title">${escapeHtml(title)}</h3>
          ${canceled ? '<span class="canceled-badge" style="margin-left:auto;">Canceled</span>' : ""}
        </div>
        <div class="modal-meta">
          <div><strong>Date:</strong> ${escapeHtml(dateText)}</div>
          ${timeText ? `<div><strong>Time:</strong> ${escapeHtml(timeText)}</div>` : ""}
          ${location ? `<div><strong>Location:</strong> ${escapeHtml(location)}</div>` : ""}
          ${category ? `<div><strong>Category:</strong> ${escapeHtml(category)}</div>` : ""}
        </div>
      `;

      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.classList.add("modal-open");
    }

    function closeEventModal() {
      const modal = document.getElementById("eventModal");
      if (!modal) return;
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    }


    // Expected CSV headers (row 1):
    // Event Date, Start Time, End Time, Title, Location, Category, Canceled
    // Also accepts: Date, Start, End (for compatibility with existing sheets)

    function setStatus(text, kind = "") {
      const el = document.getElementById("status");
      el.textContent = text;
      el.classList.remove("error", "ok");
      if (kind) el.classList.add(kind);
    }

    function setUpdated(timestamp) {
      const el = document.getElementById("updated");
      if (!el) return;
      const formatted = timestamp
        ? new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short"
        }).format(timestamp)
        : "‚Äî";
      el.textContent = `Last updated: ${formatted}`;
    }

    function stableColorForCategory(category) {
      // deterministic HSL color from string
      const s = String(category ?? "Other");
      let hash = 0;
      for (let i = 0; i < s.length; i++) hash = (hash * 31 + s.charCodeAt(i)) >>> 0;
      const hue = hash % 360;
      // Keep colors readable
      return {
        backgroundColor: `hsl(${hue} 70% 45%)`,
        borderColor: `hsl(${hue} 70% 35%)`
      };

    }
    async function loadCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results),
          error: (err) => reject(err)
        });
      });
    }

    async function main() {
      if (!CSV_URL || CSV_URL === "YOUR_CSV_URL_HERE") {
        setStatus("Error: Paste your published CSV URL into CSV_URL in index.html.", "error");
        return;
      }

      setStatus("Loading events‚Ä¶");
      setUpdated(null);
      let parsed;
      try {
        parsed = await loadCSV(CSV_URL);
      } catch (e) {
        setStatus("Error loading CSV. Verify the sheet is published to the web as CSV and the URL is correct.", "error");
        return;
      }

      if (parsed.errors && parsed.errors.length) {
        setStatus("CSV parsed with errors. Check the published tab and header row formatting.", "error");
        // continue anyway
      }

      const rows = Array.isArray(parsed.data) ? parsed.data : [];
      const events = [];
      for (const row of rows) {
        const ev = toFullCalendarEvent(row);
        if (ev) events.push(ev);
      }

      if (!events.length) {
        setStatus("No events found. Confirm your public_events tab has rows and the expected headers.", "error");
        return;
      }

      setStatus(`Loaded ${events.length} events.`, "ok");
      setUpdated(new Date());

      const isMobile = window.matchMedia("(max-width: 640px)").matches;
      const initialView = isMobile ? "fourWeekList" : "fourWeekGrid";

      const calendarEl = document.getElementById("calendar");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView,
        height: "auto",
        nowIndicator: true,
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: ""
        },
        views: {
          fourWeekGrid: { type: "dayGrid", duration: { weeks: 4 } },
          fourWeekList: { type: "list", duration: { weeks: 4 } }
        },
        firstDay: 0,
        fixedWeekCount: false,
        showNonCurrentDates: true,
        visibleRange: function(currentDate) {
          const start = startOfWeekSunday(currentDate);
          const end = addDays(start, 28);
          return { start, end };
        },
        events,

        dayCellClassNames: function(arg) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const cell = new Date(arg.date);
          cell.setHours(0, 0, 0, 0);
          return cell < today ? ["is-past"] : [];
        },

        eventClassNames: function(arg) {
          const now = new Date();
          const end = arg.event.end ? arg.event.end : arg.event.start;
          return end && end < now ? ["event-past"] : [];
        },

        eventClick: function(info) {
          info.jsEvent.preventDefault();
          openEventModal(info.event);
        },

        // Display times in 12-hour format
        eventTimeFormat: {
          hour: "numeric",
          minute: "2-digit",
          meridiem: "short"
        },

        // Include location + category + canceled status in popover
        eventDidMount: function (info) {
          const { location, category, canceled } = info.event.extendedProps;

          // Add canceled badge for quick scan
          if (canceled) {
            const titleEl = info.el.querySelector(".fc-event-title");
            if (titleEl && !info.el.querySelector(".canceled-badge")) {
              const badge = document.createElement("span");
              badge.className = "canceled-badge";
              badge.textContent = "Canceled";
              titleEl.appendChild(badge);
            }
          }

          // Tooltip (native title)
          const parts = [];
          if (category) parts.push(category);
          if (location) parts.push(location);
          if (canceled) parts.push("Canceled");
          if (parts.length) info.el.title = parts.join(" ‚Ä¢ ");
        }
      });

      calendar.render();

      // Modal wiring
      const modalEl = document.getElementById("eventModal");
      modalEl.addEventListener("click", (e) => {
        if (e.target && e.target.matches("[data-close]")) closeEventModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalEl.classList.contains("open")) closeEventModal();
      });

      // Auto-roll: keep the first week as the current Sunday‚ÄìSaturday week
      let lastWeekStart = startOfWeekSunday(new Date()).getTime();
      setInterval(() => {
        const now = new Date();
        const weekStart = startOfWeekSunday(now).getTime();
        if (weekStart !== lastWeekStart) {
          lastWeekStart = weekStart;
          calendar.gotoDate(now);
        }
        // Refresh past-event styling in list view
        calendar.rerenderEvents();
      }, 300000); // 5 minutes

      // Optional: re-render on resize to switch default view if desired
      // (Leave disabled to avoid jarring view switches)
    }

    main();
  </script>
</body>

</html>